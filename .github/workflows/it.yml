name: Web3 URL Link Checker
env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true
on:
  push: {}
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours
    - cron: "0 2 * * *"  # Every day at 10 AM UTC+8

  workflow_dispatch: # Manual trigger

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: |
          npm install node-fetch @actions/core @actions/github
          npm install ethstorage-sdk

      - name: Check Links
        id: link-check
        run: |
          node << 'EOF'
          import core from '@actions/core';
          import { checkAllLinks } from './it/scripts/check-links.mjs';
          import { links } from './it/data/links.mjs';
          import { addLinks } from './it/scripts/add-links.mjs';

          async function run() {
            const newLinks = await addLinks(${{ secrets.PRIVATE_KEY }});
            const allLinks = [...links, ...newLinks];
            const results = await checkAllLinks(allLinks);
            if (!results.success) {
              const formattedFailures = results.failures.map(failure => 
                `- URL: ${failure.url} Error: ${failure.error}\n`
              ).join('\n');
              core.setOutput('failures', formattedFailures);
            }
            const formattedResults = results.results.map(result => 
              `- URL: ${result.url} Success: ${result.success}`
            ).join('\n');
            core.setOutput('results', formattedResults);
          }

          run();
          EOF

      - name: Send Failure Email
        if: ${{ steps.link-check.outputs.failures != '' }}
        uses: ./.github/workflows/notify.yml
        with:
          subject: "❌ Web3Gateway Links Failure"
          body: |
            The following links failed:
            ${{ steps.link-check.outputs.failures }}
          secrets: inherit

      - name: Send Daily Success Email
        if: ${{ (steps.link-check.outputs.failures == '' && github.event.schedule == '0 2 * * *' ) || (github.event_name == 'workflow_dispatch') }}
        uses: ./.github/workflows/notify.yml
        with:
          subject: "✅ Web3Gateway Links Check Successful"
          body: |
            All links are healthy:
            ${{ steps.link-check.outputs.results }}
          secrets: inherit
