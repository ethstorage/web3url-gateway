name: Link Checker

on:
  schedule:
    - cron: "0 * * * *" # Hourly
  workflow_dispatch: # Manual trigger

jobs:
  check-links:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: npm install node-fetch @actions/core @actions/github

      - name: Load environment variables
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: Check Links
        id: link-check
        run: |
          node << 'EOF'
          import { checkAllLinks } from './it/scripts/check-links.mjs';
          import core from '@actions/core';

          async function run() {
            const results = await checkAllLinks('./it/data/links.json');
            if (!results.success) {
              core.setFailed('Link check failed');
              core.setOutput('failures', JSON.stringify(results.failures));
            }
            core.setOutput('results', JSON.stringify(results.results));
          }

          run();
          EOF

      - name: Send Failure Email
        if: failure()
        # uses: dawidd6/action-send-mail@v3 
        run: |
          echo "Sending failure email"
          echo "SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}"
          echo "SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}"
        # with:
        #   server_address: smtp.gmail.com
        #   server_port: 465
        #   username: ${{ secrets.SMTP_USERNAME }}
        #   password: ${{ secrets.SMTP_PASSWORD }}
        #   subject: "❌ Web3Gateway Link Check Failed"
        #   body: |
        #     The following links failed:
        #     ${{ steps.link-check.outputs.failures }}
        #   to: ${{ secrets.NOTIFICATION_EMAIL }}
        #   from: Web3Gateway Link Checker

      - name: Send Daily Success Email
        if: success() && github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.SMTP_USERNAME}}
          password: ${{secrets.SMTP_PASSWORD}}
          subject: "✅ Web3Gateway Daily Link Check Successful"
          body: |
            All links are healthy:
            ${{ steps.link-check.outputs.results }}
          to: ${{secrets.NOTIFICATION_EMAIL}}
          from: Web3Gateway Link Checker
